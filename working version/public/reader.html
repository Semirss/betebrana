<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Document Reader</title>
    <!-- Element UI CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        * {
            margin: 0;
            padding: 0;
           
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        #app {
            width: 100%;
            height: 100%;
        }
        
        .reader-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            transition: all 0.3s ease;
        }
        
        .reader-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: #f5f7fa;
            border-bottom: 1px solid #e4e7ed;
            transition: all 0.3s ease;
        }
        
        .reader-content {
            flex: 1;
            position: relative;
            overflow: auto;
            transition: all 0.3s ease;
        }
        
        /* EPUB Reader */
        #epub-container {
            width: 100%;
            height: 100%;
        }
        
        /* PDF Reader */
        #pdf-container {
            width: 100%;
            height: 100%;
            overflow: auto;
            transition: background 0.3s ease;
        }
        
        .pdf-page {
            margin: 10px auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        /* DOCX/DOC Content */
        .docx-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px;
            line-height: 1.6;
            background: white;
            min-height: 100%;
            transition: all 0.3s ease;
        }
        
        .docx-content h1 {
            font-size: 2em;
            margin-bottom: 20px;
            border-bottom: 2px solid #e4e7ed;
            padding-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        .docx-content h2 {
            font-size: 1.5em;
            margin: 25px 0 15px 0;
            transition: all 0.3s ease;
        }
        
        .docx-content p {
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .docx-content table {
            border-collapse: collapse;
            margin: 20px 0;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .docx-content table, .docx-content th, .docx-content td {
            border: 1px solid #ddd;
            transition: all 0.3s ease;
        }
        
        .docx-content th, .docx-content td {
            padding: 8px 12px;
            text-align: left;
            transition: all 0.3s ease;
        }
        
        .docx-content ul, .docx-content ol {
            margin: 15px 0;
            padding-left: 30px;
        }
        
        /* TXT Content */
        .txt-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px;
            line-height: 1.6;
            white-space: pre-wrap;
            font-family: inherit;
            background: white;
            min-height: 100%;
            transition: all 0.3s ease;
        }
        
        .library-container {
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
            height: 100vh;
            overflow: auto;
            transition: all 0.3s ease;
        }
        
        .library-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .book-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .book-item {
            border: 1px solid #e4e7ed;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .book-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .book-cover {
            width: 100%;
            height: 150px;
            background: #f5f7fa;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 2em;
            transition: all 0.3s ease;
        }
        
        .book-info h3 {
            margin-bottom: 5px;
            font-size: 14px;
            word-break: break-word;
        }
        
        .book-info p {
            color: #909399;
            font-size: 12px;
            margin-bottom: 5px;
        }
        
        .file-type {
            display: inline-block;
            padding: 2px 8px;
            background: #409eff;
            color: white;
            border-radius: 10px;
            font-size: 10px;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .book-title {
            font-weight: bold;
            font-size: 16px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 18px;
            flex-direction: column;
            gap: 20px;
        }
        
        /* THEME STYLES */
        
        /* Light Theme (Default) */
        .theme-light {
            background: #ffffff;
            color: #333333;
        }
        
        .theme-light .reader-header {
            background: #f5f7fa;
            color: #333333;
            border-bottom-color: #e4e7ed;
        }
        
        .theme-light .reader-footer {
            background: #f5f7fa;
            color: #333333;
            border-top-color: #e4e7ed;
        }
        
        .theme-light .docx-content,
        .theme-light .txt-content {
            background: #ffffff;
            color: #333333;
        }
        
        .theme-light .docx-content h1,
        .theme-light .docx-content h2 {
            color: #333333;
            border-bottom-color: #e4e7ed;
        }
        
        .theme-light #pdf-container {
            background: #525659;
        }
        
        /* Dark Theme */
        .theme-dark {
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .theme-dark .reader-header {
            background: #2d2d2d;
            color: #e0e0e0;
            border-bottom-color: #404040;
        }
        
        .theme-dark .reader-footer {
            background: #2d2d2d;
            color: #e0e0e0;
            border-top-color: #404040;
        }
        
        .theme-dark .docx-content,
        .theme-dark .txt-content {
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .theme-dark .docx-content h1,
        .theme-dark .docx-content h2 {
            color: #e0e0e0;
            border-bottom-color: #404040;
        }
        
        .theme-dark .docx-content table,
        .theme-dark .docx-content th,
        .theme-dark .docx-content td {
            border-color: #404040;
        }
        
        .theme-dark #pdf-container {
            background: #2d2d2d;
        }
        
        /* Tan Theme */
        .theme-tan {
            background: #fdf6e3;
            color: #657b83;
        }
        
        .theme-tan .reader-header {
            background: #eee8d5;
            color: #657b83;
            border-bottom-color: #d5c9a7;
        }
        
        .theme-tan .reader-footer {
            background: #eee8d5;
            color: #657b83;
            border-top-color: #d5c9a7;
        }
        
        .theme-tan .docx-content,
        .theme-tan .txt-content {
            background: #fdf6e3;
            color: #657b83;
        }
        
        .theme-tan .docx-content h1,
        .theme-tan .docx-content h2 {
            color: #586e75;
            border-bottom-color: #d5c9a7;
        }
        
        .theme-tan #pdf-container {
            background: #f0e8d5;
        }
        
        /* Blue Theme */
        .theme-blue {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .theme-blue .reader-header {
            background: #bbdefb;
            color: #0d47a1;
            border-bottom-color: #90caf9;
        }
        
        .theme-blue .reader-footer {
            background: #bbdefb;
            color: #0d47a1;
            border-top-color: #90caf9;
        }
        
        .theme-blue .docx-content,
        .theme-blue .txt-content {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .theme-blue .docx-content h1,
        .theme-blue .docx-content h2 {
            color: #0d47a1;
            border-bottom-color: #90caf9;
        }
        
        .theme-blue .docx-content table,
        .theme-blue .docx-content th,
        .theme-blue .docx-content td {
            border-color: #90caf9;
        }
        
        .theme-blue #pdf-container {
            background: #bbdefb;
        }
        
        /* Green Theme */
        .theme-green {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .theme-green .reader-header {
            background: #c8e6c9;
            color: #1b5e20;
            border-bottom-color: #a5d6a7;
        }
        
        .theme-green .reader-footer {
            background: #c8e6c9;
            color: #1b5e20;
            border-top-color: #a5d6a7;
        }
        
        .theme-green .docx-content,
        .theme-green .txt-content {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .theme-green .docx-content h1,
        .theme-green .docx-content h2 {
            color: #1b5e20;
            border-bottom-color: #a5d6a7;
        }
        
        .theme-green .docx-content table,
        .theme-green .docx-content th,
        .theme-green .docx-content td {
            border-color: #a5d6a7;
        }
        
        .theme-green #pdf-container {
            background: #c8e6c9;
        }
        
        /* Library Theme Adaptations */
        .theme-dark .library-container {
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .theme-dark .book-item {
            background: #2d2d2d;
            border-color: #404040;
            color: #e0e0e0;
        }
        
        .theme-dark .book-cover {
            background: #404040;
        }
        
        .theme-dark .book-info p {
            color: #b0b0b0;
        }
        
        .theme-tan .library-container {
            background: #fdf6e3;
            color: #657b83;
        }
        
        .theme-blue .library-container {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .theme-green .library-container {
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .error-message {
            color: #f56c6c;
            text-align: center;
            margin-top: 20px;
        }
        
        .theme-selector {
            margin: 10px 0;
        }
        
        .theme-preview {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
            border: 2px solid transparent;
        }
        
        .theme-light .theme-preview { background: linear-gradient(45deg, #ffffff 50%, #333333 50%); }
        .theme-dark .theme-preview { background: linear-gradient(45deg, #2d2d2d 50%, #e0e0e0 50%); }
        .theme-tan .theme-preview { background: linear-gradient(45deg, #eee8d5 50%, #657b83 50%); }
        .theme-blue .theme-preview { background: linear-gradient(45deg, #bbdefb 50%, #1565c0 50%); }
        .theme-green .theme-preview { background: linear-gradient(45deg, #c8e6c9 50%, #2e7d32 50%); }

        .book-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .book-item:hover .book-actions {
            opacity: 1;
        }
        
        .empty-library {
            text-align: center;
            padding: 60px 20px;
            color: #909399;
        }
        
        .empty-library h3 {
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .empty-library p {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Reader View -->
        <div class="reader-container" :class="`theme-${theme}`" v-if="currentBook">
            <!-- Header -->
            <div class="reader-header">
                <div class="control-group">
                    <el-button icon="el-icon-back" circle @click="goBack"></el-button>
                    <el-button icon="el-icon-s-grid" circle @click="showLibrary"></el-button>
                    <el-button v-if="currentBook.type === 'epub'" icon="el-icon-arrow-left" circle @click="prevPage"></el-button>
                    <el-button v-if="currentBook.type === 'epub'" icon="el-icon-arrow-right" circle @click="nextPage"></el-button>
                </div>
                
                <div class="book-title">{{ currentBook.title }}</div>
                
                <div class="control-group">
                    <el-button icon="el-icon-zoom-out" circle @click="zoomOut"></el-button>
                    <el-button icon="el-icon-zoom-in" circle @click="zoomIn"></el-button>
                    <el-button icon="el-icon-search" circle @click="toggleSearch"></el-button>
                    <el-button icon="el-icon-s-operation" circle @click="showSettings"></el-button>
                </div>
            </div>
            
            <!-- Reader Content -->
            <div class="reader-content">
                <!-- Loading State -->
                <div v-if="!isReady" class="loading">
                    <el-button type="text" :loading="true">Loading {{ currentBook.type.toUpperCase() }}...</el-button>
                    <div v-if="loadError" class="error-message">
                        {{ loadError }}
                    </div>
                </div>
                
                <!-- EPUB Reader -->
                <div v-else-if="currentBook.type === 'epub'" id="epub-container"></div>
                
                <!-- PDF Reader -->
                <div v-else-if="currentBook.type === 'pdf'" id="pdf-container">
                    <canvas v-for="page in pdfPages" :key="page.pageNumber" :id="`pdf-page-${page.pageNumber}`" class="pdf-page"></canvas>
                </div>
                
                <!-- DOCX/DOC Reader -->
                <div v-else-if="currentBook.type === 'docx' || currentBook.type === 'doc'" class="docx-content" v-html="docxContent"></div>
                
                <!-- TXT Reader -->
                <div v-else-if="currentBook.type === 'txt'" class="txt-content">{{ txtContent }}</div>
                
                <!-- Unsupported Format -->
                <div v-else class="loading">
                    Unsupported file format: {{ currentBook.type }}
                </div>
            </div>
            
            <!-- Footer -->
            <div class="reader-footer" v-if="currentBook.type === 'epub' || currentBook.type === 'pdf'">
                <el-slider 
                    v-model="progress" 
                    :format-tooltip="formatProgress" 
                    @change="onProgressChange"
                    style="width: 100%">
                </el-slider>
            </div>
        </div>
        
        <!-- Library View -->
        <div v-else class="library-container" :class="`theme-${theme}`">
            <div class="library-header">
                <h1>Document Library</h1>
                <div class="control-group">
                    <el-button icon="el-icon-s-operation" circle @click="showSettings"></el-button>
                    <el-button type="primary" icon="el-icon-plus" @click="openFile">
                        Add Document
                    </el-button>
                </div>
            </div>
            
            <div v-if="bookList.length === 0" class="empty-library">
                <h3>No documents yet</h3>
                <p>Click "Add Document" to start reading!</p>
                <el-button type="primary" icon="el-icon-plus" @click="openFile">
                    Add Your First Document
                </el-button>
                <p style="margin-top: 20px; font-size: 14px;">
                    Supported formats: EPUB, PDF, DOCX, DOC, TXT
                </p>
            </div>
            
            <div v-else class="book-list">
                <div v-for="book in bookList" :key="book.id" class="book-item" @click="openBook(book)">
                    <div class="book-actions">
                        <el-button size="mini" icon="el-icon-delete" circle @click.stop="removeBook(book)"></el-button>
                    </div>
                    <div class="book-cover">
                        <span v-if="book.type === 'epub'">📖</span>
                        <span v-else-if="book.type === 'pdf'">📄</span>
                        <span v-else-if="book.type === 'docx' || book.type === 'doc'">📝</span>
                        <span v-else-if="book.type === 'txt'">📃</span>
                        <span v-else>📁</span>
                    </div>
                    <div class="book-info">
                        <h3>{{ book.title }}</h3>
                        <p>{{ book.author || 'Unknown Author' }}</p>
                        <span class="file-type">{{ book.type.toUpperCase() }}</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Search Dialog -->
        <el-dialog title="Search" :visible.sync="searchVisible" width="500px" :class="`theme-${theme}`">
            <el-input v-model="searchText" placeholder="Enter search term" @input="onSearch"></el-input>
            <div class="search-results" style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
                <div v-if="searchResults.length === 0 && searchText" style="text-align: center; color: #909399; padding: 20px;">
                    No results found for "{{ searchText }}"
                </div>
                <div v-for="result in searchResults" :key="result.index" class="search-result" 
                     @click="goToSearchResult(result)" style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; line-height: 1.4;">
                    <div style="font-size: 12px; color: #409eff; margin-bottom: 4px;">
                        Result {{ result.index + 1 }}
                    </div>
                    {{ result.text }}
                </div>
            </div>
        </el-dialog>
        
        <!-- Settings Dialog -->
        <el-dialog title="Reading Settings" :visible.sync="settingsVisible" width="400px" :class="`theme-${theme}`">
            <el-form label-width="100px">
                <el-form-item label="Theme">
                    <el-radio-group v-model="theme" @change="applyTheme" class="theme-selector">
                        <el-radio label="light">
                            <span class="theme-preview"></span>
                            Light
                        </el-radio>
                        <el-radio label="dark">
                            <span class="theme-preview"></span>
                            Dark
                        </el-radio>
                        <el-radio label="tan">
                            <span class="theme-preview"></span>
                            Tan
                        </el-radio>
                        <el-radio label="blue">
                            <span class="theme-preview"></span>
                            Blue
                        </el-radio>
                        <el-radio label="green">
                            <span class="theme-preview"></span>
                            Green
                        </el-radio>
                    </el-radio-group>
                </el-form-item>
                
                <el-form-item label="Font Size">
                    <el-input-number v-model="fontSize" :min="12" :max="24" :step="2"></el-input-number>
                </el-form-item>
                
                <el-form-item label="Zoom Level">
                    <el-input-number v-model="zoomLevel" :min="0.5" :max="3" :step="0.1" :precision="1"></el-input-number>
                </el-form-item>
            </el-form>
        </el-dialog>
    </div>

    <!-- Libraries -->
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/epubjs/dist/epub.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
    <script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>
    
    <script>
        // Set PDF.js worker path
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.4.120/build/pdf.worker.min.js';

        // File storage management
        const fileStorage = {
            // Store files in IndexedDB for persistence
            async storeFile(id, file) {
                return new Promise((resolve) => {
                    // For simplicity, we'll use localStorage with Base64 encoding
                    // In a production app, you'd use IndexedDB
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const fileData = {
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            lastModified: file.lastModified,
                            data: e.target.result
                        };
                        localStorage.setItem(`file-${id}`, JSON.stringify(fileData));
                        resolve();
                    };
                    reader.readAsDataURL(file);
                });
            },

            async getFile(id) {
                const fileData = JSON.parse(localStorage.getItem(`file-${id}`));
                if (!fileData) return null;
                
                // Convert base64 back to blob
                const response = await fetch(fileData.data);
                const blob = await response.blob();
                
                // Recreate the file object
                return new File([blob], fileData.name, {
                    type: fileData.type,
                    lastModified: fileData.lastModified
                });
            },

            removeFile(id) {
                localStorage.removeItem(`file-${id}`);
            }
        };

        // Simple localStorage-based database
        const db = {
            getAll() {
                return JSON.parse(localStorage.getItem('document-library') || '[]');
            },
            get(id) {
                const books = this.getAll();
                return books.find(book => book.id === id);
            },
            async set(id, data) {
                const books = this.getAll();
                const index = books.findIndex(book => book.id === id);
                if (index !== -1) {
                    books[index] = data;
                } else {
                    books.push(data);
                }
                localStorage.setItem('document-library', JSON.stringify(books));
                
                // Store the file separately
                if (data.file && data.file instanceof File) {
                    await fileStorage.storeFile(id, data.file);
                }
            },
            async remove(id) {
                const books = this.getAll();
                const filtered = books.filter(book => book.id !== id);
                localStorage.setItem('document-library', JSON.stringify(filtered));
                fileStorage.removeFile(id);
            }
        };

        new Vue({
            el: '#app',
            data() {
                return {
                    currentBook: null,
                    bookList: [],
                    isReady: false,
                    loadError: null,
                    progress: 0,
                    searchVisible: false,
                    searchText: '',
                    searchResults: [],
                    settingsVisible: false,
                    theme: 'light',
                    fontSize: 16,
                    zoomLevel: 1.0,
                    
                    // EPUB
                    rendition: null,
                    book: null,
                    
                    // PDF
                    pdfDoc: null,
                    pdfPages: [],
                    
                    // DOCX/DOC
                    docxContent: '',
                    
                    // TXT
                    txtContent: '',

                    // File cache for currently open files
                    fileCache: new Map()
                };
            },
            
            async mounted() {
                // Load saved theme from localStorage
                const savedTheme = localStorage.getItem('reader-theme');
                if (savedTheme) {
                    this.theme = savedTheme;
                }
                await this.loadLibrary();
                this.applyTheme();
            },
            
            methods: {
                async loadLibrary() {
                    this.bookList = db.getAll();
                },
                
                async openFile() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.epub,.pdf,.docx,.doc,.txt';
                    input.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            await this.loadBook(file);
                        }
                    };
                    input.click();
                },
                
                async loadBook(file) {
                    const fileExtension = file.name.split('.').pop().toLowerCase();
                    const bookId = 'book-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    
                    const bookInfo = {
                        id: bookId,
                        title: file.name.replace(/\.[^/.]+$/, ""), // Remove extension
                        file: file,
                        type: fileExtension,
                        lastOpen: new Date().getTime()
                    };
                    
                    await db.set(bookId, bookInfo);
                    await this.openBook(bookInfo);
                },
                
                async openBook(bookInfo) {
                    this.currentBook = bookInfo;
                    this.isReady = false;
                    this.loadError = null;
                    
                    try {
                        // Get the actual file from storage
                        let file = bookInfo.file;
                        if (!(file instanceof File)) {
                            file = await fileStorage.getFile(bookInfo.id);
                            if (!file) {
                                throw new Error('File not found in storage');
                            }
                            // Update the current book with the actual file
                            this.currentBook.file = file;
                        }
                        
                        // Cache the file for this session
                        this.fileCache.set(bookInfo.id, file);
                        
                        switch(bookInfo.type) {
                            case 'epub':
                                await this.loadEPUB(file);
                                break;
                            case 'pdf':
                                await this.loadPDF(file);
                                break;
                            case 'docx':
                            case 'doc':
                                await this.loadDOCX(file);
                                break;
                            case 'txt':
                                await this.loadTXT(file);
                                break;
                            default:
                                throw new Error(`Unsupported file type: ${bookInfo.type}`);
                        }
                        this.isReady = true;
                    } catch (error) {
                        console.error('Error loading book:', error);
                        this.loadError = `Failed to load ${bookInfo.type.toUpperCase()} file: ${error.message}`;
                        this.$message.error(`Error loading ${bookInfo.type.toUpperCase()} file`);
                    }
                },
                
                // EPUB Loader
                async loadEPUB(file) {
                    return new Promise((resolve, reject) => {
                        try {
                            this.book = ePub(file);
                            this.rendition = this.book.renderTo("epub-container", {
                                width: "100%",
                                height: "100%",
                                spread: "none"
                            });
                            
                            this.book.ready.then(() => {
                                this.rendition.display();
                                this.rendition.on("relocated", (location) => {
                                    this.progress = location.percentage * 100;
                                });
                                resolve();
                            }).catch(reject);
                        } catch (error) {
                            reject(error);
                        }
                    });
                },
                
                // PDF Loader
                async loadPDF(file) {
                    try {
                        const arrayBuffer = await file.arrayBuffer();
                        this.pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
                        this.pdfPages = [];
                        
                        for (let i = 1; i <= this.pdfDoc.numPages; i++) {
                            this.pdfPages.push({ pageNumber: i });
                        }
                        
                        await this.renderPDFPages();
                    } catch (error) {
                        throw new Error(`PDF loading failed: ${error.message}`);
                    }
                },
                
                async renderPDFPages() {
                    for (let page of this.pdfPages) {
                        const pdfPage = await this.pdfDoc.getPage(page.pageNumber);
                        const canvas = document.getElementById(`pdf-page-${page.pageNumber}`);
                        if (!canvas) continue;
                        
                        const context = canvas.getContext('2d');
                        const viewport = pdfPage.getViewport({ scale: this.zoomLevel * 1.5 });
                        
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        
                        await pdfPage.render({
                            canvasContext: context,
                            viewport: viewport
                        }).promise;
                    }
                },
                
                // DOCX/DOC Loader
                async loadDOCX(file) {
                    try {
                        if (typeof mammoth === 'undefined') {
                            throw new Error('DOCX library not loaded. Please check your internet connection.');
                        }
                        
                        const arrayBuffer = await file.arrayBuffer();
                        const result = await mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
                        
                        if (result.value) {
                            this.docxContent = result.value;
                        } else {
                            throw new Error('No content could be extracted from the document');
                        }
                    } catch (error) {
                        console.error('DOCX conversion error:', error);
                        this.docxContent = `
                            <div style="text-align: center; padding: 50px;">
                                <h3>Unable to display DOCX content</h3>
                                <p>Error: ${error.message}</p>
                                <p>Try downloading the file and opening it with Microsoft Word or LibreOffice.</p>
                            </div>
                        `;
                        throw error;
                    }
                },
                
                // TXT Loader
                async loadTXT(file) {
                    try {
                        this.txtContent = await file.text();
                        if (!this.txtContent.trim()) {
                            throw new Error('File appears to be empty');
                        }
                    } catch (error) {
                        throw new Error(`Text file loading failed: ${error.message}`);
                    }
                },
                
                // Navigation Methods
                prevPage() {
                    if (this.rendition) {
                        this.rendition.prev();
                    }
                },
                
                nextPage() {
                    if (this.rendition) {
                        this.rendition.next();
                    }
                },
                
                goBack() {
                    if (this.currentBook.type === 'epub') {
                        this.prevPage();
                    } else if (this.currentBook.type === 'pdf') {
                        const container = document.getElementById('pdf-container');
                        container.scrollTop -= 500;
                    } else {
                        // For DOCX/TXT, scroll up
                        const container = document.querySelector('.reader-content');
                        container.scrollTop -= 200;
                    }
                },
                
                showLibrary() {
                    this.currentBook = null;
                    this.loadLibrary();
                },
                
                async removeBook(book) {
                    try {
                        this.$confirm('This will permanently delete the document. Continue?', 'Warning', {
                            confirmButtonText: 'OK',
                            cancelButtonText: 'Cancel',
                            type: 'warning'
                        }).then(async () => {
                            await db.remove(book.id);
                            this.fileCache.delete(book.id);
                            await this.loadLibrary();
                            this.$message({
                                type: 'success',
                                message: 'Document deleted'
                            });
                        });
                    } catch (error) {
                        this.$message.error('Error deleting document');
                    }
                },
                
                zoomIn() {
                    this.zoomLevel = Math.min(3.0, this.zoomLevel + 0.1);
                    this.applyZoom();
                },
                
                zoomOut() {
                    this.zoomLevel = Math.max(0.5, this.zoomLevel - 0.1);
                    this.applyZoom();
                },
                
                applyZoom() {
                    const effectiveSize = this.fontSize * this.zoomLevel;
                    
                    if (this.currentBook.type === 'pdf') {
                        this.renderPDFPages();
                    } else if (this.currentBook.type === 'docx' || this.currentBook.type === 'doc') {
                        const content = document.querySelector('.docx-content');
                        if (content) {
                            content.style.fontSize = `${effectiveSize}px`;
                        }
                    } else if (this.currentBook.type === 'txt') {
                        const content = document.querySelector('.txt-content');
                        if (content) {
                            content.style.fontSize = `${effectiveSize}px`;
                        }
                    }
                },
                
                applyTheme() {
                    // Save theme to localStorage
                    localStorage.setItem('reader-theme', this.theme);
                    
                    // Apply theme to EPUB if available
                    if (this.rendition) {
                        this.rendition.themes.select(this.theme);
                    }
                    
                    // Update PDF container background
                    this.updatePDFBackground();
                },
                
                updatePDFBackground() {
                    if (this.currentBook && this.currentBook.type === 'pdf') {
                        const pdfContainer = document.getElementById('pdf-container');
                        if (pdfContainer) {
                            // Background color will be applied via CSS based on theme class
                        }
                    }
                },
                
                toggleSearch() {
                    this.searchVisible = !this.searchVisible;
                    this.searchText = '';
                    this.searchResults = [];
                },
                
                onSearch() {
                    if (!this.searchText.trim()) {
                        this.searchResults = [];
                        return;
                    }
                    
                    const searchTerm = this.searchText.toLowerCase();
                    this.searchResults = [];
                    
                    if (this.currentBook.type === 'txt') {
                        const lines = this.txtContent.split('\n');
                        lines.forEach((line, index) => {
                            if (line.toLowerCase().includes(searchTerm)) {
                                this.searchResults.push({
                                    text: line.trim() || '(empty line)',
                                    index: index,
                                    type: 'line'
                                });
                            }
                        });
                    } else if (this.currentBook.type === 'docx' || this.currentBook.type === 'doc') {
                        // Simple text search in DOCX content
                        const textContent = this.docxContent.replace(/<[^>]*>/g, ' ');
                        const sentences = textContent.split(/[.!?]+/).filter(s => s.trim());
                        sentences.forEach((sentence, index) => {
                            if (sentence.toLowerCase().includes(searchTerm)) {
                                this.searchResults.push({
                                    text: sentence.trim().substring(0, 100) + '...',
                                    index: index,
                                    type: 'sentence'
                                });
                            }
                        });
                    }
                    
                    // Limit results
                    this.searchResults = this.searchResults.slice(0, 20);
                },
                
                goToSearchResult(result) {
                    if (this.currentBook.type === 'txt') {
                        const txtElement = document.querySelector('.txt-content');
                        const lines = this.txtContent.split('\n');
                        const approxPosition = (result.index / lines.length) * txtElement.scrollHeight;
                        txtElement.scrollTop = approxPosition;
                    }
                    this.searchVisible = false;
                },
                
                showSettings() {
                    this.settingsVisible = true;
                },
                
                onProgressChange(value) {
                    if (this.rendition) {
                        if (this.book.locations) {
                            const cfi = this.book.locations.cfiFromPercentage(value / 100);
                            this.rendition.display(cfi);
                        }
                    } else if (this.currentBook.type === 'pdf') {
                        const pageNumber = Math.ceil((value / 100) * this.pdfDoc.numPages);
                        const pageElement = document.getElementById(`pdf-page-${pageNumber}`);
                        if (pageElement) {
                            pageElement.scrollIntoView();
                        }
                    }
                },
                
                formatProgress(value) {
                    return `${value.toFixed(1)}%`;
                }
            },
            
            watch: {
                fontSize() {
                    this.applyZoom();
                },
                
                zoomLevel() {
                    this.applyZoom();
                }
            }
        });
    </script>
</body>
</html>